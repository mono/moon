<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Test file</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
      <script src="jtr.js"></script>
</head>
<body>

<div id="Moonlight">

</div>

<script type="text/javascript">
	var mediaElement = null;
	var host = null;
	var dlA = null;

	// 0: not checked, 1: checked, but failed, 2: checked and succeeded
	var progress_checked = 0;
	var completed_checked = 0;

	ontestready = OnTestReady;

	function change_dl ()
	{
		TestLogger.LogDebug ("Changing to dlB");
		mediaElement.SetSource (dlB, "");
		setTimeout ("EndTest ();", 5000);
		TestLogger.LogDebug ("Changed, source: " + mediaElement.Source);
	}

	function EndTest ()
	{
		TestLogger.LogDebug ("EndTest");
		if (progress_checked == 2 && completed_checked == 2)
			TestLogger.LogResult (1);
		else
			TestLogger.LogResult (-1);
		document.getElementById ("_TestPlugin").SignalShutdown (document.name);
	}

	function OnTestReady ()
	{
		try {
			TestLogger.LogDebug ("OnTestReady");
			host = document.getElementById ("JoltActiveX");
			mediaElement = host.content.findName ("media");

			dlA = host.createObject ("Downloader");
			dlB = host.createObject ("Downloader");

			dlA.addEventListener("Completed", "CompletedEvent");
			dlA.addEventListener("DownloadProgressChanged", "DownloadProgressChangedEvent");
			dlA.addEventListener("DownloadFailed", "DownloadFailedEvent");
			dlA.Open ("GET", "../timecode.mpeg"); // The biggest file I could find in svn
			dlA.Send ();
		} catch (ex) {
			alert (ex + "");
		}
	}

	function DownloadProgressChangedEvent (sender, args)
	{
		TestLogger.LogDebug ("DownloadProgressChangedEvent: " + sender.Uri + ", " + sender.DownloadProgress);

		if (progress_checked != 0 || completed_checked != 0)
			return;

		try {
			mediaElement.SetSource (dlA, "");
			progress_checked = sender.DownloadProgress == 1 ? 2 : 1;
			TestLogger.LogError ("DownloadProgressChangedEvent: We shouldn't be able to set the source to a partially downloaded downloader.");
		} catch (ex) {
			progress_checked = sender.DownloadProgress == 1 ? 1 : 2;
		}
	}
	function CompletedEvent (sender, args)
	{
		TestLogger.LogDebug ("CompletedEvent: " + sender.Uri);

		if (completed_checked != 0)
			return;

		try {
			mediaElement.SetSource (dlA, "");
			completed_checked = 2;
		} catch (ex) {
			completed_checked = 1;
			TestLogger.LogError ("CompletedEvent: Setting the source failed.");
		}
		EndTest ();
	}

	function DownloadFailedEvent (sender, args)
	{
		TestLogger.LogError ("DownloadFailedEvent: " + sender.Uri + ", " + ErrorEventArgsToOneLineString (args));
		EndTest ();
	}

	function OnPluginError (sender, args)
	{
		TestLogger.LogError (errorString);
		TestLogger.LogResult (-1)
		EndTest ();
	}

	function OnPluginLoaded (o, e)
	{
		TestLogger.LogDebug ("OnPluginLoaded");
		setTimeout ("OnTestReady ();", 100);
	}

function ErrorEventArgsToOneLineString (errorArgs)
{
    var errorMsg = "";

        if (errorArgs == null)
                return "null";

    // Error information common to all errors.
    errorMsg += "Error Type:    " + errorArgs.errorType;
    errorMsg += ", " + "Error Message: " + errorArgs.errorMessage;
    errorMsg += ", " + "Error Code:    " + errorArgs.errorCode;

    // Determine the type of error and add specific error information.
    switch (errorArgs.errorType)  {
    case "RuntimeError":
        // Display properties specific to RuntimeErrorEventArgs.
        if (errorArgs.lineNumber != 0)
        {
            errorMsg += ", " + "Line: " + errorArgs.lineNumber;
            errorMsg += ", " + "Position: " +  errorArgs.charPosition;
        }
        errorMsg += ", " + "MethodName: " + errorArgs.methodName;
        break;
    case "ParserError":
        // Display properties specific to ParserErrorEventArgs.
        errorMsg += ", " + "Xaml File:      " + errorArgs.xamlFile;
        errorMsg += ", " + "Xml Element:    " + errorArgs.xmlElement;
        errorMsg += ", " + "Xml Attribute:  " + errorArgs.xmlAttribute;
        errorMsg += ", " + "Line:           " + errorArgs.lineNumber;
        errorMsg += ", " + "Position:       " + errorArgs.charPosition;
        break;
    default:
        break;
    }
        return errorMsg;
}

</script>

<div>
<embed type="application/x-silverlight" width="800" height="580"
     id="JoltActiveX" Source="test-downloader-aborted-in-setsource.xaml" OnError="OnPluginError" OnLoad="OnPluginLoaded"
     style="position:absolute; left:0px; top:0px" background="#CCCCCC">
</embed>
</div>

<embed id="_TestPlugin" width="0" height="0" type="application/x-jolttest">
</embed>

</body>

</html>
